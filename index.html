<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valanja Vazhi — Nammakk choich choich povam</title>

  <!-- Tailwind (quick) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>

  <!-- Toastify for popups -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    #map { min-height: 60vh; }
    .card { background: rgba(255,255,255,0.92); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-extrabold">🛣️ Valanja Vazhi <span class="text-yellow-600">🎯</span></h1>
        <p class="text-sm text-gray-600">"Nammakk choich choich povam" — Because straight roads are for amateurs 😎</p>
      </div>
      <div class="text-sm text-gray-700">
        <div><strong>Team:</strong> Traffic Trolls</div>
        <div>Samuel M Dileep • Muhammed Shibin</div>
      </div>
    </header>

    <section class="grid md:grid-cols-3 gap-6">
      <div class="md:col-span-2 space-y-4">
        <div class="card p-4 rounded shadow">
          <div class="flex gap-3 items-center">
            <input id="destInput" class="flex-1 px-3 py-2 border rounded" placeholder="(Or click on map to set destination)" />
            <select id="mode" class="px-3 py-2 border rounded text-sm">
              <option>🐌 Snail Mode</option>
              <option>🚜 Tractor Mode</option>
              <option>🌀 Looping Mode</option>
              <option>🌳 Scenic Route Mode</option>
              <option>🏗️ Under Construction Mode</option>
              <option>🐄 Cow Crossing Mode</option>
              <option>🎡 Festival Detour Mode</option>
            </select>
            <button id="showWorst" class="bg-red-600 text-white px-4 py-2 rounded font-semibold">Show Me the Worst Way</button>
            <button id="resetBtn" class="px-3 py-2 border rounded">Reset</button>
          </div>

          <div id="map" class="mt-4 rounded"></div>

          <div class="mt-3 flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">Current Route</p>
              <h3 id="eta" class="text-xl font-bold">ETA: —</h3>
              <p id="dist" class="text-sm text-gray-600 mt-1">Distance: —</p>
            </div>

            <div class="text-right">
              <p class="text-sm text-gray-500">Misery Meter</p>
              <div class="w-48 bg-gray-200 rounded-full overflow-hidden mt-1">
                <div id="misery" class="h-3 bg-yellow-500 w-8/12"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-3 rounded shadow text-sm">
          <strong>How to use</strong>
          <ul class="list-disc list-inside mt-2">
            <li>Allow location access when prompted.</li>
            <li>Click anywhere on the map to set destination (or paste coordinates into input).</li>
            <li>Choose a delay mode and click <em>Show Me the Worst Way</em>.</li>
          </ul>
        </div>
      </div>

      <aside class="space-y-4">
        <div class="card p-3 rounded shadow">
          <h4 class="font-semibold">Why Valanja Vazhi?</h4>
          <p class="text-sm mt-2">Because straight routes are boring. We choose dramatic delays with style.</p>
        </div>

        <div class="card p-3 rounded shadow">
          <h4 class="font-semibold">Random Lines</h4>
          <div id="lines" class="mt-2 text-sm space-y-1"></div>
        </div>

        <div class="card p-3 rounded shadow text-sm">
          <strong>Run:</strong>
          <div class="mt-2">Open this file in the browser. Token already embedded (replace if needed).</div>
        </div>
      </aside>
    </section>

    <footer class="text-center text-xs text-gray-500">Made with ❤️, detours 🌀, and light horn abuse 🚗📢 at TinkerHub Useless Projects</footer>
  </div>

<script>
/* ============================
   Configuration — replace token if needed
   ============================ */
const MAPBOX_TOKEN = "pk.eyJ1Ijoic2FtdWVsbWRpbGVlcCIsImEiOiJjbWN0Mjd4a2cwMG92MmpxdXo3cDlveTlsIn0.QLTaJV0psYYAr9jpJeZjUw";

/* ============================
   Helpers & UI
   ============================ */
function toast(text, bg="#ff5858"){
  Toastify({ text, duration: 3500, gravity:"top", position:"right", style:{background: bg} }).showToast();
}

const randomLines = [
  "Nammakk choich choich povam!",
  "Vazhi thetti poyi alle?",
  "Sheri... ini njan poyi varatte.",
  "Ee vazhi aano? Ithinekkal nalla road njan kanichu tharam.",
  "Inganonnum alleda.",
  "Onnu pethiye poda… enikk ee deshathe vazhi ariyillann."
];
const linesEl = document.getElementById('lines');
randomLines.forEach(l => {
  const p = document.createElement('p'); p.textContent = "“" + l + "”"; linesEl.appendChild(p);
});

/* ============================
   Mapbox init & geolocation
   ============================ */
mapboxgl.accessToken = MAPBOX_TOKEN;

let map, userLocation = null;
let destMarker = null;
let routeLayerId = "valanja-route-layer";
let currentRouteGeoJSON = null;

function initMap(center){
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: center,
    zoom: 12
  });

  map.addControl(new mapboxgl.NavigationControl());

  // show traffic style layer (Mapbox traffic source)
  map.on('load', () => {
    // traffic source & layer: (Mapbox traffic tiles)
    try {
      map.addLayer({
        'id': 'traffic',
        'type': 'line',
        'source': {
          type: 'vector',
          url: 'mapbox://mapbox.mapbox-traffic-v1'
        },
        'source-layer': 'traffic',
        'layout': { 'line-cap': 'round', 'line-join': 'round' },
        'paint': {
          'line-color': [
            'match',
            ['get', 'congestion'],
            ['low'], '#2ecc71',
            ['moderate'], '#f1c40f',
            ['heavy'], '#e67e22',
            ['severe'], '#e74c3c',
            '#e67e22'
          ],
          'line-width': 3,
          'line-opacity': 0.9
        }
      }, 'waterway-label'); // place under labels where possible
    } catch (e) {
      console.warn("Traffic layer add failed (maybe style restrictions).", e);
    }
  });

  // click to set destination
  map.on('click', (e) => {
    setDestination([e.lngLat.lng, e.lngLat.lat]);
  });

  // show user marker
  if(userLocation){
    new mapboxgl.Marker({ color: "blue" })
      .setLngLat(userLocation)
      .setPopup(new mapboxgl.Popup().setText("You are here 🐌"))
      .addTo(map);
  }
}

function setDestination(lnglat){
  // remove old dest
  if(destMarker) destMarker.remove();
  destMarker = new mapboxgl.Marker({ color: "darkred" })
    .setLngLat(lnglat)
    .setPopup(new mapboxgl.Popup().setText("Destination"))
    .addTo(map);
  // zoom to dist
  map.flyTo({ center: lnglat, zoom: 13 });
  document.getElementById('destInput').value = lnglat[1].toFixed(5) + ", " + lnglat[0].toFixed(5);
}

/* ============================
   Directions: fetch alternatives & pick worst
   ============================ */

async function getAlternatives(start, end){
  // Mapbox Directions API: alternatives=true
  const coords = `${start[0]},${start[1]};${end[0]},${end[1]}`;
  const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?alternatives=true&geometries=geojson&overview=full&steps=false&access_token=${MAPBOX_TOKEN}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("Directions API error: " + res.status);
  const data = await res.json();
  return data.routes || [];
}

function pickWorstRoute(routes, mode){
  if(!routes || routes.length === 0) return null;

  // base score: distance (m) + a small weight * duration (s)
  // mode multipliers to encourage longer/worse routes
  const modeMultiplier = {
    "🐌 Snail Mode": 1.4,
    "🚜 Tractor Mode": 1.7,
    "🌀 Looping Mode": 2.2,
    "🌳 Scenic Route Mode": 1.6,
    "🏗️ Under Construction Mode": 1.9,
    "🐄 Cow Crossing Mode": 1.8,
    "🎡 Festival Detour Mode": 2.5
  }[mode] || 1.5;

  // Evaluate each route
  let best = null;
  let bestScore = -Infinity;
  routes.forEach(r => {
    const distance = r.distance; // meters
    const duration = r.duration; // seconds

    // score: prefer longer distance and longer duration
    let score = distance + duration * 10; // tweak
    score *= modeMultiplier;

    // extra penalty if route has many coordinates (more turns)
    const complexity = r.geometry.coordinates.length;
    score += complexity * 5;

    if(score > bestScore){ bestScore = score; best = r; }
  });

  return best;
}

function drawRoute(route, styleColor="#d6336c"){
  // remove old layer/source
  if(map.getLayer(routeLayerId)) { map.removeLayer(routeLayerId); }
  if(map.getSource(routeLayerId)) { map.removeSource(routeLayerId); }

  const geo = {
    type: "Feature",
    geometry: route.geometry
  };
  map.addSource(routeLayerId, { type: "geojson", data: geo });
  map.addLayer({
    id: routeLayerId,
    type: "line",
    source: routeLayerId,
    layout: { "line-join": "round", "line-cap": "round" },
    paint: { "line-color": styleColor, "line-width": 6, "line-opacity": 0.9 }
  });
  // update ETA & distance
  const mins = Math.round(route.duration / 60);
  document.getElementById('eta').textContent = `ETA: ${mins} mins`;
  document.getElementById('dist').textContent = `Distance: ${(route.distance/1000).toFixed(2)} km`;

  // fit to bounds
  const coords = route.geometry.coordinates;
  const bounds = coords.reduce((b, c) => b.extend(c), new mapboxgl.LngLatBounds(coords[0], coords[0]));
  map.fitBounds(bounds, { padding: 60 });
}

/* ============================
   UI actions
   ============================ */

document.getElementById('showWorst').addEventListener('click', async () => {
  try {
    if(!userLocation) {
      toast("Waiting for location... allow location access and try again.", "#ffb86b");
      return;
    }

    // parse dest input or check dest marker
    let destValue = document.getElementById('destInput').value.trim();
    let destCoords = null;
    if(destValue){
      // allow "lat, lng" or "lng, lat", we try to parse both
      const parts = destValue.replace(/,/g, ' ').split(/\s+/).filter(Boolean).map(Number);
      if(parts.length >= 2 && !isNaN(parts[0]) && !isNaN(parts[1])){
        // if first looks like lat (between -90 and 90), treat as lat,lng
        if(Math.abs(parts[0]) <= 90 && Math.abs(parts[1]) <= 180){
          // assume lat,lng => convert to [lng,lat]
          destCoords = [parts[1], parts[0]];
        } else {
          destCoords = [parts[0], parts[1]];
        }
      }
    }
    // fallback: if dest marker exists, use it
    if(!destCoords && destMarker){
      destCoords = destMarker.getLngLat().toArray();
    }

    if(!destCoords){
      toast("Set a destination by clicking on the map or typing coordinates.", "#f6caca");
      return;
    }

    const mode = document.getElementById('mode').value;
    toast(`Finding the most hopeless route in ${mode}...`, "#ff7b7b");

    // get alternatives
    const routes = await getAlternatives([userLocation[0], userLocation[1]], [destCoords[0], destCoords[1]]);
    if(routes.length === 0){
      toast("No routes found.", "#f6caca");
      return;
    }
    // pick worst
    let worst = pickWorstRoute(routes, mode);

    // If Looping Mode: add an artificial loop overlay near route midpoint for extra chaos
    if(mode.includes("Looping") && worst){
      // compute midpoint coordinate
      const coords = worst.geometry.coordinates;
      const midIdx = Math.floor(coords.length / 2);
      const mid = coords[midIdx];
      // create a small circular loop polyline (geojson)
      const loop = [];
      const radius = 0.0025; // degrees approx ~ ~250m
      for(let i=0;i<12;i++){
        const ang = (i / 12) * Math.PI * 2;
        loop.push([ mid[0] + Math.cos(ang)*radius, mid[1] + Math.sin(ang)*radius ]);
      }
      // merge: create a new geometry with route coords + loop inserted after midpoint
      const newCoords = coords.slice(0, midIdx+1).concat(loop).concat(coords.slice(midIdx+1));
      worst = Object.assign({}, worst); // shallow copy
      worst.geometry = { type: "LineString", coordinates: newCoords };
      // slightly inflate distance/duration for UI
      worst.distance = worst.distance * 1.25;
      worst.duration = worst.duration * 1.4;
    }

    // draw the route
    drawRoute(worst, "#c92a2a");

    // cheerful toast & misery meter update
    toast("Route selected: maximum regret guaranteed 🚗💥", "#ff6b6b");
    // update misery meter
    const misery = document.getElementById('misery');
    const score = Math.min(100, Math.round((worst.distance/1000) * 3 + (worst.duration/60) * 0.8));
    misery.style.width = Math.max(10, Math.min(100, score)) + "%";

  } catch (err) {
    console.error(err);
    toast("Something went wrong: " + (err.message || "error"), "#f8a5a5");
  }
});

document.getElementById('resetBtn').addEventListener('click', () => {
  if(map.getLayer(routeLayerId)) map.removeLayer(routeLayerId);
  if(map.getSource(routeLayerId)) map.removeSource(routeLayerId);
  document.getElementById('eta').textContent = "ETA: —";
  document.getElementById('dist').textContent = "Distance: —";
  document.getElementById('misery').style.width = "8%";
  if(destMarker) { destMarker.remove(); destMarker = null; }
  document.getElementById('destInput').value = "";
  toast("Reset. For now 😉", "#b8e994");
});

/* ============================
   get user location and initialize
   ============================ */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition((pos)=>{
    userLocation = [pos.coords.longitude, pos.coords.latitude];
    initMap(userLocation);
  }, (err)=>{
    console.warn("Geolocation failed:", err);
    // fallback center (Kochi)
    userLocation = [76.2673, 9.9312];
    initMap(userLocation);
    toast("Location disabled or blocked — using Kochi as fallback.", "#f6caca");
  }, { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000});
} else {
  alert("Geolocation not supported by your browser.");
  userLocation = [76.2673, 9.9312];
  initMap(userLocation);
}
</script>
</body>
</html>
