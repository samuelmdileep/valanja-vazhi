<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Valanja Vazhi Maps ğŸ—ºï¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin:0; padding:0; }
    #map { width: 100%; height: 90vh; }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <h1 class="text-2xl font-bold text-center py-3">Valanja Vazhi Maps ğŸŒ</h1>

  <!-- Mode Selector -->
  <div class="flex justify-center gap-2 my-2">
    <select id="mode" class="text-black p-2 rounded">
      <option value="normal">ğŸš— Normal Mode</option>
      <option value="snail">ğŸŒ Snail Mode</option>
      <option value="tractor">ğŸšœ Tractor Mode</option>
      <option value="looping">ğŸŒ€ Looping Mode</option>
    </select>
    <input id="search" type="text" placeholder="Search place..." class="text-black p-2 rounded w-60" />
    <button id="go" class="bg-green-500 px-3 rounded">Go</button>
  </div>

  <div id="map"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FtdWVsbWRpbGVlcCIsImEiOiJjbWN0Mjd4a2cwMG92MmpxdXo3cDlveTlsIn0.QLTaJV0psYYAr9jpJeZjUw';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [76.2673, 9.9312],
      zoom: 13
    });

    map.addControl(new mapboxgl.NavigationControl());

    let userMarker;
    let destMarker;
    const routeLayerId = 'route';

    // Major places with coordinates (add Neriyamangalam & Munnar as well)
    const majorPlaces = {
      Perumbavoor: [76.5446, 10.1071],
      Muvattupuzha: [76.6017, 9.9589],
      Kolenchery: [76.5143, 10.0621],
      Aluva: [76.3940, 10.1070],
      Kothamangalam: [76.5850, 10.1133],
      Thodupuzha: [76.7185, 9.8789],
      Pala: [76.7156, 9.7156],
      Theni: [77.5212, 10.0180],
      Pollachi: [77.0022, 10.6610],
      Ranni: [76.8496, 9.3307],
      Pathanamthitta: [76.7833, 9.2640],
      Adoor: [76.8004, 9.1720],
      Punaloor: [76.8992, 9.0081],
      Thenkashi: [77.3241, 8.9602],
      Neriyamangalam: [76.8033, 10.0644],
      Munnar: [77.0595, 10.0889]
    };

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const lng = pos.coords.longitude;
        const lat = pos.coords.latitude;

        if (!userMarker) {
          userMarker = new mapboxgl.Marker({ color: 'blue' }).setLngLat([lng, lat]).addTo(map);
        } else {
          userMarker.setLngLat([lng, lat]);
        }
      }, err => console.error(err), { enableHighAccuracy: true });
    }

    function toRad(deg) { return deg * Math.PI / 180; }

    function distanceBetween(coord1, coord2) {
      const R = 6371;
      const dLat = toRad(coord2[1] - coord1[1]);
      const dLng = toRad(coord2[0] - coord1[0]);
      const lat1 = toRad(coord1[1]);
      const lat2 = toRad(coord2[1]);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Check if a coord is near a major place (within ~10km)
    function findNearestMajorPlace(coord) {
      let nearest = null;
      let minDist = 10000;
      for (const [name, placeCoord] of Object.entries(majorPlaces)) {
        const dist = distanceBetween(coord, placeCoord);
        if (dist < 10 && dist < minDist) {
          minDist = dist;
          nearest = name;
        }
      }
      return nearest;
    }

    document.getElementById('go').addEventListener('click', async () => {
      const place = document.getElementById('search').value.trim();
      const mode = document.getElementById('mode').value;

      if (!place) return alert('Type a place name!');

      try {
        // Geocode destination
        const geoRes = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(place)}.json?access_token=${mapboxgl.accessToken}`);
        const geoData = await geoRes.json();

        if (!geoData.features.length) return alert('Place not found');

        const dest = geoData.features[0].geometry.coordinates;

        // Place or move destination marker
        if (!destMarker) {
          destMarker = new mapboxgl.Marker({ color: 'red' }).setLngLat(dest).addTo(map);
        } else {
          destMarker.setLngLat(dest);
        }

        // Start coords: user location or default Kochi
        const start = userMarker ? userMarker.getLngLat().toArray() : [76.2673, 9.9312];

        // Routing profile (walking for snail, driving otherwise)
        let profile = mode === 'snail' ? 'walking' : 'driving';

        let waypoints = [];

        if (mode === 'snail') {
          // Check if start is near Kothamangalam & destination near Munnar to apply custom waypoint chain
          const startNear = findNearestMajorPlace(start);
          const destNear = findNearestMajorPlace(dest);

          if (startNear === 'Kothamangalam' && destNear === 'Munnar') {
            // Fixed waypoint chain for snail mode (order important)
            waypoints = [
              majorPlaces.Perumbavoor,
              majorPlaces.Muvattupuzha,
              majorPlaces.Thodupuzha,
              majorPlaces.Neriyamangalam
            ];
            console.log('Snail mode: Using fixed waypoint chain for Kothamangalam -> Munnar');
          } else {
            // Default snail: pick waypoint ~30km from start if available
            // (Reuse previous logic: find nearest waypoint ~30km away)
            // We'll pick one waypoint near 30 km radius for demo:
            for (const [name, coords] of Object.entries(majorPlaces)) {
              const dist = distanceBetween(start, coords);
              if (dist >= 25 && dist <= 35) {
                waypoints.push(coords);
                break;
              }
            }
            if (waypoints.length === 0) {
              console.log('Snail mode: no suitable waypoint ~30km found, using direct route');
            }
          }
        } else if (mode === 'tractor') {
          // Tractor mode example waypoint ~15km away
          for (const [name, coords] of Object.entries(majorPlaces)) {
            const dist = distanceBetween(start, coords);
            if (dist >= 10 && dist <= 20) {
              waypoints.push(coords);
              break;
            }
          }
        } else if (mode === 'looping') {
          // Looping mode: visit 2 places then return to start then destination
          let count = 0;
          for (const [name, coords] of Object.entries(majorPlaces)) {
            if (count >= 2) break;
            const distStart = distanceBetween(start, coords);
            const distDest = distanceBetween(coords, dest);
            const directDist = distanceBetween(start, dest);
            if (distStart + distDest > directDist + 5 && distStart + distDest < directDist + 40) {
              waypoints.push(coords);
              count++;
            }
          }
          waypoints.push(start);
        }
        // Normal mode: no waypoints

        // Build directions coordinates string
        let coordsString = `${start[0]},${start[1]}`;
        waypoints.forEach(wp => {
          coordsString += `;${wp[0]},${wp[1]}`;
        });
        coordsString += `;${dest[0]},${dest[1]}`;

        const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/${profile}/${coordsString}?geometries=geojson&access_token=${mapboxgl.accessToken}`;

        const dirRes = await fetch(directionsUrl);
        const dirData = await dirRes.json();

        if (!dirData.routes || dirData.routes.length === 0) return alert('No route found');

        const route = dirData.routes[0].geometry;

        if (!route || !route.coordinates || route.coordinates.length === 0) {
          return alert('Route geometry invalid or empty');
        }

        // Remove old route layer if exists
        if (map.getLayer(routeLayerId)) {
          map.removeLayer(routeLayerId);
          map.removeSource(routeLayerId);
        }

        // Paint styles per mode
        let paint = {
          'line-color': '#ff0000',
          'line-width': 4,
          'line-opacity': 1
        };
        if (mode === 'snail') {
          paint['line-color'] = '#00ff00';
          paint['line-dasharray'] = [2, 4];
          paint['line-width'] = 3;
        } else if (mode === 'tractor') {
          paint['line-color'] = '#ffa500';
          paint['line-width'] = 6;
        } else if (mode === 'looping') {
          paint['line-color'] = '#00ffff';
          paint['line-width'] = 4;
          paint['line-opacity'] = 0.7;
        }

        // Add route to map
        map.addSource(routeLayerId, {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: route
          }
        });

        map.addLayer({
          id: routeLayerId,
          type: 'line',
          source: routeLayerId,
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: paint
        });

        // Fit map bounds to route
        const bounds = new mapboxgl.LngLatBounds();
        route.coordinates.forEach(c => bounds.extend(c));
        map.fitBounds(bounds, { padding: 50, maxZoom: 14 });

        // Only start (blue) and destination (red) markers - no waypoint markers
        if (window.waypointMarker) {
          window.waypointMarker.remove();
          window.waypointMarker = null;
        }

      } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + error.message);
      }
    });
  </script>
</body>
</html>
